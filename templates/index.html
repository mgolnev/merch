<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог товаров</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 15px;
            padding-right: 15px;
        }
        .container-fluid {
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 15px;
            padding-right: 15px;
        }
        .product-card {
            margin-bottom: 20px;
            padding-left: 8px;
            padding-right: 8px;
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            height: 100%;
            border-radius: 12px;
            background: white;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .image-container {
            height: 300px;
            overflow: hidden;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 12px 12px 0 0;
            padding: 0;
        }
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            padding: 0;
        }
        .metrics {
            font-size: 0.9em;
            color: #666;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .metrics p {
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        .metrics span {
            font-weight: 500;
        }
        .pagination {
            margin: 2rem 0;
        }
        .page-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .card-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            min-height: 3rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 500;
        }
        .sku {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }
        .category {
            font-size: 0.875rem;
            color: #0d6efd;
            margin-bottom: 0.75rem;
            display: inline-block;
        }
        .price-block {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .current-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #212529;
        }
        .old-price {
            text-decoration: line-through;
            color: #6c757d;
            font-size: 1.1rem;
        }
        .discount-badge {
            background-color: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .filters-container {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .filter-section {
            position: relative;
            margin-bottom: 0;
        }
        .filter-section label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: white;
            padding: 0 8px;
            font-size: 0.8rem;
            color: #6c757d;
            z-index: 1;
        }
        .filter-section select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .filter-section select:focus {
            background-color: white;
            border-color: #0d6efd;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
        }
        .input-group {
            position: relative;
            margin-bottom: 0;
        }
        .input-group label {
            position: absolute;
            top: -8px;
            left: 12px;
            background: white;
            padding: 0 8px;
            font-size: 0.8rem;
            color: #6c757d;
            z-index: 1;
        }
        .input-group .form-control {
            padding: 0.875rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: #f8f9fa;
        }
        .input-group .form-control:focus {
            background-color: white;
            border-color: #0d6efd;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
        }
        .input-group .btn {
            margin-left: -1px;
            padding: 0.875rem 1.25rem;
            border: 1px solid #e9ecef;
            background-color: #f8f9fa;
            color: #6c757d;
            transition: all 0.2s ease;
            border-radius: 0 12px 12px 0;
        }
        .input-group .btn:hover {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
        }
        .form-switch {
            padding-left: 3.5em;
            display: flex;
            align-items: center;
        }
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            margin-left: -3.5em;
            background-color: #e9ecef;
            border-color: #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .form-check-label {
            font-size: 0.95rem;
            color: #495057;
            cursor: pointer;
            user-select: none;
        }
        .header {
            background-color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .score-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(33, 37, 41, 0.85);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 1;
            backdrop-filter: blur(4px);
        }
        .score-value {
            font-weight: bold;
            color: #ffc107;
        }
        .card-body {
            padding: 1.25rem;
        }
        .form-check {
            margin-bottom: 0;
        }
        .category-search {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .category-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .category-search input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }
        
        .category-select {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .category-select option {
            padding: 0.5rem 1rem;
        }
        
        .category-search-container {
            position: relative;
            margin-bottom: 0.75rem;
        }
        
        .category-search-clear {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            font-size: 1.1rem;
            opacity: 0.5;
            transition: all 0.2s ease;
        }
        
        .category-search-clear:hover {
            opacity: 1;
            color: #dc3545;
        }
        
        .category-search-clear.visible {
            display: block;
        }
        
        #categorySearch {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95rem;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
        }

        #categorySearch:focus {
            background-color: white;
            border-color: #0d6efd;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
        }

        .product-card a {
            display: block;
            height: 100%;
            transition: transform 0.2s ease-in-out;
        }

        .product-card a:hover {
            transform: translateY(-5px);
        }

        .product-card a:hover .card {
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .product-card-ghost {
            opacity: 0.5;
            background: #c8ebfb;
        }

        #saveCategoryOrder, #exportCategory {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            border: none;
        }

        #saveCategoryOrder {
            background-color: #0d6efd;
            color: white;
        }

        #saveCategoryOrder:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
        }

        #exportCategory {
            background-color: #198754;
            color: white;
        }

        #exportCategory:hover {
            background-color: #157347;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.2);
        }

        /* Стили для кнопок действий */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: #198754;
            border-color: #198754;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .btn-success:hover {
            background-color: #157347;
            border-color: #157347;
            transform: translateY(-1px);
        }

        /* Стили для переключателя */
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            background-color: #e9ecef;
            border-color: #e9ecef;
        }

        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        /* Стили для кнопок категорий */
        .category-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        /* Стили для поиска */
        .search-container {
            position: relative;
        }

        .search-container .form-control {
            padding-right: 2.5rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        .search-container .form-control:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .search-container .btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            border: none;
            background: transparent;
            color: #6c757d;
            transition: color 0.2s ease;
        }

        .search-container .btn:hover {
            color: #0d6efd;
        }

        /* === ДОБАВЛЮ СТИЛИ ДЛЯ РЕЗИНОВОЙ ШАПКИ КАРТОЧКИ === */
        .product-header {
            background: rgba(33, 37, 41, 0.85);
            color: #fff;
            border-radius: 12px 12px 0 0;
            padding: 0.5rem 0.75rem;
            min-height: 48px;
            font-size: 0.95rem;
            z-index: 2;
            position: relative;
        }
        .score-badge {
            background: none;
            color: #fff;
            font-size: 1rem;
            font-weight: 500;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            position: static;
            text-align: center;
            width: 100%;
        }
        .pagination-footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background: #f8f9fa;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.07);
            z-index: 100;
            padding: 0.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination-footer .container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination-footer nav, .pagination-footer .ms-3 {
            margin-bottom: 0 !important;
        }
        .container-fluid, .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 15px;
            padding-right: 15px;
        }
        @media (max-width: 768px) {
            .product-header {
                font-size: 0.85rem;
                min-height: 38px;
                padding: 0.25rem 0.5rem;
            }
            .score-badge {
                font-size: 0.9rem;
            }
            .pagination-footer {
                flex-direction: column;
                padding: 0.5rem 0.2rem;
            }
        }
        .dnp {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .availability {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .availability i {
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Каталог товаров</h1>
                <div>
                    <button type="button" class="btn btn-outline-danger me-2" id="resetButton">
                        <i class="bi bi-arrow-counterclockwise"></i> Сбросить веса
                    </button>
                    <a href="/weights" class="btn btn-outline-primary">
                        <i class="bi bi-sliders"></i> Настройка скоринга
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="filters-container">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <div class="input-group">
                        <label for="searchInput">Поиск по артикулу</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Введите артикул..." autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-section">
                        <label for="categorySearch">Категория</label>
                        <div class="category-search-container">
                            <input type="text" id="categorySearch" class="form-control" placeholder="Поиск по категории..." autocomplete="off">
                            <button type="button" class="category-search-clear" id="categoryClear">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        <select id="categorySelect" class="form-select category-select" size="1">
                            <option value="all">Все категории</option>
                        </select>
                        <div class="category-buttons mt-2">
                            <button id="saveCategoryOrder" style="display: none;" class="btn btn-primary">
                                <i class="bi bi-save"></i> Сохранить порядок
                            </button>
                            <button id="exportCategory" style="display: none;" class="btn btn-success">
                                <i class="bi bi-download"></i> Выгрузить в CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-section">
                        <label for="genderFilter">Пол</label>
                        <select id="genderFilter">
                            <option value="all">Все полы</option>
                            <option value="Девочки">Девочки</option>
                            <option value="Женщины">Женщины</option>
                            <option value="Мальчики">Мальчики</option>
                            <option value="Мужчины">Мужчины</option>
                            <option value="Унисекс">Унисекс</option>
                            <option value="empty">Не указан</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="hideNoPriceSwitch" checked>
                        <label class="form-check-label" for="hideNoPriceSwitch">
                            <i class="bi bi-tag-fill me-1"></i>
                            Скрыть товары без цены
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3" id="productsContainer">
            <!-- Товары будут загружены здесь -->
        </div>

        <div class="pagination-footer">
            <div class="container">
                <nav aria-label="Навигация по страницам">
                    <ul class="pagination" id="pagination">
                        <!-- Пагинация будет загружена здесь -->
                    </ul>
                </nav>
                <div class="ms-3">
                    <label for="perPageSelect" class="form-label mb-0 me-2" style="font-weight: 500;">Показывать по:</label>
                    <select id="perPageSelect" class="form-select d-inline-block" style="width: auto; display: inline-block;">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentCategory = 'all';
        let currentGender = 'all';
        let totalPages = 1;
        let hideNoPrice = true;
        let searchQuery = '';
        let allCategories = [];
        let currentProducts = [];
        let perPage = 20;

        async function loadCategories() {
            const response = await fetch('/api/categories');
            const categories = await response.json();
            
            allCategories = categories;
            
            // Сортировка уже не нужна, так как категории приходят отсортированными с сервера
            updateCategorySelect();
        }

        function updateCategorySelect(searchQuery = '') {
            const select = document.getElementById('categorySelect');
            const clearButton = document.getElementById('categoryClear');
            select.innerHTML = '';
            clearButton.classList.toggle('visible', searchQuery.length > 0);
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Все категории';
            select.appendChild(allOption);
            allCategories
                .filter(cat => {
                    if (!searchQuery) return true;
                    
                    // Если поисковый запрос состоит только из цифр
                    if (/^\d+$/.test(searchQuery)) {
                        return cat.category_number && String(cat.category_number) === searchQuery;
                    }
                    
                    // Для текстового поиска используем включение в
                    return (cat.name && cat.name.toLowerCase().includes(searchQuery.toLowerCase())) ||
                           (cat.category_number && String(cat.category_number).includes(searchQuery));
                })
                .forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_number;
                    option.textContent = `${category.category_number} – ${category.name}`;
                    select.appendChild(option);
                });
            const searchInput = document.getElementById('categorySearch');
            if (searchQuery || document.activeElement === searchInput) {
                select.size = Math.min(10, select.options.length);
                select.classList.add('show');
            } else {
                select.size = 1;
                select.classList.remove('show');
            }
        }

        // Добавляем обработчик для кнопки очистки
        document.getElementById('categoryClear').addEventListener('click', () => {
            const searchInput = document.getElementById('categorySearch');
            const categorySelect = document.getElementById('categorySelect');
            
            // Очищаем поле поиска
            searchInput.value = '';
            
            // Сбрасываем select на "Все категории"
            categorySelect.value = 'all';
            
            // Обновляем список категорий
            updateCategorySelect('');
            
            // Перезагружаем товары с новым фильтром
            loadProducts(1);
            
            // Возвращаем фокус в поле поиска
            searchInput.focus();
        });

        // Добавляем обработчик фокуса для поля поиска
        document.getElementById('categorySearch').addEventListener('focus', () => {
            updateCategorySelect(document.getElementById('categorySearch').value.trim());
        });

        document.addEventListener('click', (e) => {
            const select = document.getElementById('categorySelect');
            const search = document.getElementById('categorySearch');
            const clearBtn = document.getElementById('categoryClear');
            if (!select.contains(e.target) && !search.contains(e.target) && !clearBtn.contains(e.target)) {
                select.size = 1;
                select.classList.remove('show');
            }
        });

        const style = document.createElement('style');
        style.textContent = `
            .filter-section {
                position: relative;
            }
            .category-select {
                position: absolute;
                width: 100%;
                z-index: 1000;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                margin-top: 5px;
                display: none;
            }
            .category-select.show {
                display: block;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .category-select option {
                padding: 8px 12px;
                cursor: pointer;
            }
            .category-select option:hover {
                background-color: #f8f9fa;
            }
        `;
        document.head.appendChild(style);

        document.getElementById('categorySearch').addEventListener('input', (e) => {
            updateCategorySelect(e.target.value.trim());
        });

        document.getElementById('categorySelect').addEventListener('change', () => {
            const selectedOption = document.getElementById('categorySelect').options[
                document.getElementById('categorySelect').selectedIndex
            ];
            document.getElementById('categorySearch').value = selectedOption.text;
            document.getElementById('categorySelect').size = 1;
            document.getElementById('categorySelect').classList.remove('show');
            loadProducts(1);
        });

        function createPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // Кнопка "Предыдущая"
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Предыдущая</a>`;
            pagination.appendChild(prevLi);

            // Номера страниц
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || // Первая страница
                    i === totalPages || // Последняя страница
                    (i >= currentPage - 2 && i <= currentPage + 2) // Две страницы до и после текущей
                ) {
                    const li = document.createElement('li');
                    li.className = 'page-item';
                    li.innerHTML = `<a class="page-link ${i === currentPage ? 'active' : ''}" href="#" data-page="${i}">${i}</a>`;
                    pagination.appendChild(li);
                } else if (
                    i === currentPage - 3 || // Многоточие перед текущей страницей
                    i === currentPage + 3 // Многоточие после текущей страницей
                ) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
            }

            // Кнопка "Следующая"
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Следующая</a>`;
            pagination.appendChild(nextLi);

            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(e.target.dataset.page);
                    if (!isNaN(page) && page !== currentPage) {
                        loadProducts(currentCategory, page, searchQuery, currentGender);
                    }
                });
            });
        }

        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            if (products && products.length > 0) {
                products.forEach((product, index) => {
                    const card = createProductCard(product, index + 1);
                    container.appendChild(card);
                });
            } else {
                container.innerHTML = '<p class="text-center mt-5">Товары не найдены</p>';
            }
        }

        function createProductCard(product, orderNumber) {
            const card = document.createElement('div');
            card.className = 'col-md-4 col-lg-3 product-card';
            const hasDiscount = product.discount && product.discount > 0;
            const currentPrice = Math.round(product.price || 0);
            const oldPrice = Math.round(product.oldprice || 0);
            // Категории
            const categoriesHtml = product.categories && product.categories.length > 0
                ? product.categories.map(cat => `<span class=\"badge bg-secondary me-1 mb-1\">${cat}</span>`).join('')
                : '<span class=\"badge bg-secondary\">Без категории</span>';
            // Блок изображения
            let imageHtml = '';
            if (product.image_url) {
                imageHtml = `<div class=\"image-container mb-2\"><img src=\"${product.image_url}\" alt=\"${product.name}\" class=\"product-image\"></div>`;
            } else {
                imageHtml = `<div class=\"image-container mb-2 d-flex align-items-center justify-content-center\" style=\"background:#e9ecef;min-height:180px;\"><i class=\"bi bi-image\" style=\"font-size:3rem;color:#adb5bd;\"></i></div>`;
            }
            // Скор и позиция
            const scoreHtml = `<span class=\"score-badge position-absolute top-0 end-0 m-2\" title=\"Скор\" style=\"background:rgba(33,37,41,0.85);color:#ffc107;padding:0.3em 0.7em;border-radius:8px;font-size:1.1rem;z-index:2;\">★ ${product.score ?? 0}</span>`;
            const positionHtml = product.position && product.position !== 999999 ? `<span class=\"badge bg-info ms-2\" title=\"Позиция в категории\">#${product.position}</span>` : '';
            // Метрики
            const metricsHtml = `
                <div class=\"metrics mt-2\" style=\"background:#f8f9fa;padding:1em;border-radius:12px;\">
                    <div style=\"display:flex;flex-direction:column;gap:0.3em;\">
                        <div style=\"display:flex;justify-content:space-between;\"><span>Сессии:</span><span>${product.sessions ?? 0}</span></div>
                        <div style=\"display:flex;justify-content:space-between;\"><span>Просмотры:</span><span>${product.product_views ?? 0}</span></div>
                        <div style=\"display:flex;justify-content:space-between;\"><span>В корзину:</span><span>${product.cart_additions ?? 0}</span></div>
                        <div style=\"display:flex;justify-content:space-between;\"><span>Оформления:</span><span>${product.checkout_starts ?? 0}</span></div>
                        <div style=\"display:flex;justify-content:space-between;\"><span>Заказы:</span><span>${product.orders_gross ?? 0}</span></div>
                        <div style=\"display:flex;justify-content:space-between;\"><span>Net:</span><span>${product.orders_net ?? 0}</span></div>
                        ${product.sale_start_date ? `<div style=\"display:flex;justify-content:space-between;\"><span>Старт продаж:</span><span>${product.sale_start_date}</span></div>` : ''}
                    </div>
                </div>
            `;
            // Категории скрыты по умолчанию, показываются по клику
            const categoriesBlockId = `categories-${product.sku.replace(/[^a-zA-Z0-9]/g, '')}`;
            const categoriesToggleHtml = `<i class=\"bi bi-tags-fill category-toggle\" style=\"cursor:pointer;color:#0d6efd;font-size:1.2rem;\" title=\"Показать/скрыть категории\" onclick=\"toggleCategories('${categoriesBlockId}')\"></i>`;
            card.innerHTML = `
                <div class=\"card h-100 position-relative\">
                    ${scoreHtml}
                    ${imageHtml}
                    <div class=\"card-body\">
                        <div class=\"d-flex justify-content-between align-items-center mb-2\">
                            <span class=\"sku\">SKU: ${product.sku}</span>
                            <span class=\"order-number\">#${orderNumber}</span>
                        </div>
                        <div class=\"d-flex align-items-center mb-2\">
                            ${positionHtml}
                            <span class=\"ms-auto\">${categoriesToggleHtml}</span>
                        </div>
                        <p class="card-text">${product.url ? `<a href="${product.url}" target="_blank" rel="noopener noreferrer">${product.name}</a>` : product.name}</p>
                        <div id=\"${categoriesBlockId}\" class=\"categories mb-2\" style=\"display:none;\">
                            ${categoriesHtml}
                        </div>
                        <div class=\"price-block\">
                            ${hasDiscount ? `
                                <span class=\"old-price\">${oldPrice} ₽</span>
                                <span class=\"current-price\">${currentPrice} ₽</span>
                                <span class=\"discount bg-danger text-white ms-2 px-2 py-1 rounded fw-bold\" style=\"font-size:1rem;\">-${product.discount}%</span>
                            ` : `
                                <span class=\"current-price\">${currentPrice} ₽</span>
                            `}
                        </div>
                        ${metricsHtml}
                    </div>
                </div>
            `;
            return card;
        }

        function updatePagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Предыдущая страница
            const prevBtn = document.createElement('button');
            prevBtn.className = 'btn btn-outline-primary' + (currentPage === 1 ? ' disabled' : '');
            prevBtn.innerHTML = '&laquo;';
            if (currentPage > 1) {
                prevBtn.onclick = () => loadProducts(currentPage - 1);
            }
            pagination.appendChild(prevBtn);
            
            // Номера страниц
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = 'btn ' + (i === currentPage ? 'btn-primary' : 'btn-outline-primary');
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => loadProducts(i);
                    pagination.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const dots = document.createElement('span');
                    dots.className = 'pagination-dots';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }
            
            // Следующая страница
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-outline-primary' + (currentPage === totalPages ? ' disabled' : '');
            nextBtn.innerHTML = '&raquo;';
            if (currentPage < totalPages) {
                nextBtn.onclick = () => loadProducts(currentPage + 1);
            }
            pagination.appendChild(nextBtn);
        }

        function loadProducts(page = 1) {
            const category_number = document.getElementById('categorySelect').value;
            const hideNoPrice = document.getElementById('hideNoPriceSwitch').checked;
            const search = document.getElementById('searchInput').value.trim();
            const gender = document.getElementById('genderFilter').value;
            perPage = parseInt(document.getElementById('perPageSelect').value) || 20;
            
            currentPage = page;
            currentCategory = category_number;
            currentGender = gender;
            searchQuery = search;
            
            fetch(`/api/products?category=${encodeURIComponent(category_number)}&page=${page}&hide_no_price=${hideNoPrice}&search=${encodeURIComponent(search)}&gender=${encodeURIComponent(gender)}&per_page=${perPage}`)
                .then(response => response.json())
                .then(data => {
                    currentProducts = data.products;
                    displayProducts(data.products);
                    createPagination(data.page, data.total_pages);
                    
                    // Показываем или скрываем кнопки
                    const saveCategoryOrderBtn = document.getElementById('saveCategoryOrder');
                    const exportCategoryBtn = document.getElementById('exportCategory');
                    const showButtons = category_number !== 'all';
                    saveCategoryOrderBtn.style.display = showButtons ? 'inline-block' : 'none';
                    exportCategoryBtn.style.display = showButtons ? 'inline-block' : 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    const container = document.getElementById('productsContainer');
                    container.innerHTML = '<p class="text-center mt-5 text-danger">Ошибка при загрузке товаров</p>';
                });
        }

        document.getElementById('genderFilter').addEventListener('change', () => {
            loadProducts(1);
        });

        document.getElementById('hideNoPriceSwitch').addEventListener('change', () => {
            loadProducts(1);
        });

        document.getElementById('searchButton').addEventListener('click', () => {
            loadProducts(1);
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadProducts(1);
            }
        });

        // --- Новый saveCategoryOrder с поддержкой drag-and-drop и массового сохранения ---
        async function saveCategoryOrder() {
            const category_number = document.getElementById('categorySelect').value;
            if (category_number === 'all') return;

            // Получаем все товары категории
            const response = await fetch(`/api/products?category=${category_number}&page=all&hide_no_price=true&search=&gender=all&per_page=5000`);
            const data = await response.json();
            const allProducts = data.products;

            // Получаем порядок после drag-and-drop на текущей странице
            const draggedSkus = Array.from(document.querySelectorAll('.product-card .sku')).map(el =>
                el.textContent.trim().replace(/^SKU: /, '')
            );

            // Формируем итоговый массив: сначала drag-and-drop, потом остальные
            const draggedSet = new Set(draggedSkus);
            const positions = [];

            // Сначала отсортированные на странице
            draggedSkus.forEach((sku, idx) => {
                positions.push({ sku, category_number, position: idx + 1 });
            });

            // Потом остальные товары
            let pos = draggedSkus.length + 1;
            allProducts.forEach(product => {
                if (!draggedSet.has(product.sku)) {
                    positions.push({ sku: product.sku, category_number, position: pos++ });
                }
            });

            // Отправляем на сервер
            try {
                const res = await fetch('/api/category_order_bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(positions)
                });
                const result = await res.json();
                if (result.status === 'success') {
                    alert('Порядок товаров сохранён для всей категории!');
                    loadProducts(1);
                } else {
                    alert('Ошибка: ' + (result.error || 'Не удалось сохранить порядок'));
                }
            } catch (e) {
                alert('Ошибка при сохранении порядка: ' + e.message);
            }
        }
        // ... existing code ...
        // Заменяю обработчик кнопки на новый
        document.getElementById('saveCategoryOrder').addEventListener('click', saveCategoryOrder);
        // ... existing code ...

        // Добавляем drag-and-drop функциональность
        function enableDragAndDrop() {
            const container = document.getElementById('productsContainer');
            new Sortable(container, {
                animation: 150,
                ghostClass: 'product-card-ghost',
                onEnd: function(evt) {
                    // При необходимости можно добавить автоматическое сохранение после перетаскивания
                }
            });
        }

        // Вызываем функцию после загрузки страницы
        document.addEventListener('DOMContentLoaded', function() {
            enableDragAndDrop();
        });

        // Загрузка данных при открытии страницы
        loadCategories();
        loadProducts(1);

        // Добавляем обработчик для кнопки сброса
        document.getElementById('resetButton').addEventListener('click', async () => {
            const category_number = document.getElementById('categorySelect').value;
            
            if (category_number === 'all') {
                alert('Пожалуйста, выберите категорию для сброса ручных позиций');
                return;
            }
            
            if (confirm(`Вы уверены, что хотите сбросить ручные позиции в категории №${category_number}? Это действие нельзя отменить.`)) {
                try {
                    const response = await fetch('/api/reset_category_order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ category_number })
                    });

                    if (response.ok) {
                        alert('Ручные позиции успешно сброшены');
                        // Вместо window.location.reload(); вызываем только обновление товаров
                        loadProducts(1);
                    } else {
                        const data = await response.json();
                        alert(data.message || 'Ошибка при сбросе ручных позиций');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Произошла ошибка при сбросе ручных позиций');
                }
            }
        });

        // В секции JavaScript добавляем обработчик для кнопки выгрузки
        document.getElementById('exportCategory').addEventListener('click', () => {
            const category_number = document.getElementById('categorySelect').value;
            if (category_number === 'all') {
                alert('Пожалуйста, выберите категорию для выгрузки');
                return;
            }
            window.location.href = `/api/export_category/${category_number}`;
        });

        // Обновляем обработчики пагинации
        document.getElementById('pagination').addEventListener('click', (e) => {
            if (e.target.classList.contains('page-link')) {
                e.preventDefault();
                const page = parseInt(e.target.dataset.page);
                if (!isNaN(page) && page !== currentPage) {
                    loadProducts(page);
                }
            }
        });

        document.getElementById('perPageSelect').addEventListener('change', function() {
            loadProducts(1);
        });

        // Добавляю функцию для показа/скрытия категорий
        function toggleCategories(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
            }
        }
    </script>
</body>
</html> 